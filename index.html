<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kSHIB Orderbook Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .file-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .chart-container {
            width: 100%;
            height: 600px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 40px 0;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .metric {
            text-align: center;
        }
        .metric h3 {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .metric .value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }
        .info-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .code-sample {
            background: #2d2d2d;
            color: #cccccc;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .axis-label {
            font-size: 14px;
            font-weight: bold;
            fill: #333;
        }
        .axis-line {
            stroke: #333;
            stroke-width: 2;
        }
        .tick text {
            font-size: 12px;
            fill: #666;
        }
        .bids {
            fill: rgba(0, 255, 0, 0.2);
            stroke: rgb(0, 200, 0);
            stroke-width: 2;
        }
        .asks {
            fill: rgba(255, 0, 0, 0.2);
            stroke: rgb(200, 0, 0);
            stroke-width: 2;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            white-space: pre;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>kSHIB Orderbook</h1>
            <div>
                <input type="file" id="fileInput" class="file-input" accept=".txt,.json">
            </div>
        </div>
        
        <div class="info-box">
            <h3>Expected HyperLiquid JSON Format:</h3>
            <pre class="code-sample">
{
  "raw": {
    "channel": "l2Book",
    "data": {
      "coin": "kSHIB",
      "levels": [
        [ // Bids (Buy Orders)
          {"px": "0.011957", "sz": "110036.0", "n": 2},  // Price, Size, Number of Orders
          ...
        ],
        [ // Asks (Sell Orders)
          {"px": "0.011961", "sz": "117488.0", "n": 2},
          ...
        ]
      ]
    }
  }
}</pre>
        </div>
        
        <div class="metrics">
            <div class="metric">
                <h3>Best Bid</h3>
                <div id="bestBid" class="value">-</div>
            </div>
            <div class="metric">
                <h3>Best Ask</h3>
                <div id="bestAsk" class="value">-</div>
            </div>
            <div class="metric">
                <h3>Spread</h3>
                <div id="spread" class="value">-</div>
            </div>
            <div class="metric">
                <h3>Total Bid Volume</h3>
                <div id="bidVolume" class="value">-</div>
            </div>
            <div class="metric">
                <h3>Total Ask Volume</h3>
                <div id="askVolume" class="value">-</div>
            </div>
        </div>

        <div id="chart" class="chart-container"></div>
    </div>

    <script>
        // Initialize the visualization
        const margin = {top: 40, right: 60, bottom: 50, left: 150};
        const width = 1000 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        function processOrderbook(data) {
            const snapshot = JSON.parse(data);
            const levels = snapshot.raw.data.levels;
            
            // Process bids and asks
            let bids = [];
            let asks = [];
            let cumBidSize = 0;
            let cumAskSize = 0;
            
            // Process bids (buy orders)
            levels[0].forEach(bid => {
                cumBidSize += parseFloat(bid.sz);
                bids.push({
                    price: parseFloat(bid.px),
                    size: parseFloat(bid.sz),
                    cumSize: cumBidSize,
                    orders: parseInt(bid.n)
                });
            });
            
            // Process asks (sell orders)
            levels[1].forEach(ask => {
                cumAskSize += parseFloat(ask.sz);
                asks.push({
                    price: parseFloat(ask.px),
                    size: parseFloat(ask.sz),
                    cumSize: cumAskSize,
                    orders: parseInt(ask.n)
                });
            });

            return { bids, asks };
        }

        function updateMetrics(bids, asks) {
            if (bids.length === 0 || asks.length === 0) return;

            const bestBid = bids[0].price;
            const bestAsk = asks[0].price;
            const spread = bestAsk - bestBid;
            const totalBidVolume = bids[bids.length - 1].cumSize;
            const totalAskVolume = asks[asks.length - 1].cumSize;

            document.getElementById('bestBid').textContent = bestBid.toFixed(6);
            document.getElementById('bestAsk').textContent = bestAsk.toFixed(6);
            document.getElementById('spread').textContent = spread.toFixed(6);
            document.getElementById('bidVolume').textContent = totalBidVolume.toLocaleString();
            document.getElementById('askVolume').textContent = totalAskVolume.toLocaleString();
        }

        function updateVisualization(bids, asks) {
            // Clear previous elements
            svg.selectAll("*").remove();

            // Set up scales
            const xScale = d3.scaleLinear()
                .domain([
                    d3.min(bids, d => d.price) * 0.9999,
                    d3.max(asks, d => d.price) * 1.0001
                ])
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max([
                    d3.max(bids, d => d.cumSize),
                    d3.max(asks, d => d.cumSize)
                ])])
                .range([height, 0]);

            // Create step area generators for a more accurate orderbook representation
            const bidArea = d3.area()
                .x(d => xScale(d.price))
                .y0(height)
                .y1(d => yScale(d.cumSize))
                .curve(d3.curveStepAfter);  // Use steps instead of curves

            const askArea = d3.area()
                .x(d => xScale(d.price))
                .y0(height)
                .y1(d => yScale(d.cumSize))
                .curve(d3.curveStepAfter);  // Use steps instead of curves

            // Add the areas
            svg.append("path")
                .datum(bids)
                .attr("class", "bids")
                .attr("d", bidArea);

            svg.append("path")
                .datum(asks)
                .attr("class", "asks")
                .attr("d", askArea);

            // Add axes with labels
            const xAxis = d3.axisBottom(xScale).tickFormat(d3.format(".6f"));
            const yAxis = d3.axisLeft(yScale)
                .tickFormat(d => d3.format(",.0f")(d))
                .ticks(10)  // Limit number of ticks
                .tickPadding(20);  // Further increase padding between ticks and labels

            // X-axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);

            // X-axis with styling
            const xAxisG = svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);
            
            xAxisG.selectAll("path")
                .attr("class", "axis-line");
            
            // X-axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .text("Price (USDC)");

            // Y-axis with styling
            const yAxisG = svg.append("g")
                .call(yAxis);
            
            yAxisG.selectAll("path")
                .attr("class", "axis-line");
            
            // Y-axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 80)
                .text("Cumulative Size");

            // Add interactive points
            function showTooltip(event, d, type) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(
                    `${type}\nPrice: ${d.price.toFixed(6)}\nSize: ${d.size.toFixed(1)}\nCumulative: ${d.cumSize.toFixed(1)}\nOrders: ${d.orders}`
                )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }

            function hideTooltip() {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            }

            // Add bid points
            svg.selectAll(".bid-point")
                .data(bids)
                .enter()
                .append("circle")
                .attr("class", "bid-point")
                .attr("cx", d => xScale(d.price))
                .attr("cy", d => yScale(d.cumSize))
                .attr("r", 3)
                .attr("fill", "green")
                .on("mouseover", (e, d) => showTooltip(e, d, "Bid"))
                .on("mouseout", hideTooltip);

            // Add ask points
            svg.selectAll(".ask-point")
                .data(asks)
                .enter()
                .append("circle")
                .attr("class", "ask-point")
                .attr("cx", d => xScale(d.price))
                .attr("cy", d => yScale(d.cumSize))
                .attr("r", 3)
                .attr("fill", "red")
                .on("mouseover", (e, d) => showTooltip(e, d, "Ask"))
                .on("mouseout", hideTooltip);
        }

        // File input handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n').filter(line => line.trim());
                if (lines.length === 0) return;

                // Process the first snapshot
                const { bids, asks } = processOrderbook(lines[0]);
                updateMetrics(bids, asks);
                updateVisualization(bids, asks);
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>
