<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kSHIB Orderbook Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .file-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .chart-container {
            width: 100%;
            height: 600px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 40px 0;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .metric {
            text-align: center;
        }
        .metric h3 {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .metric .value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }
        .info-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .code-sample {
            background: #2d2d2d;
            color: #cccccc;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .timeline-controls {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .timeline-controls h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        .time-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }
        .time-display .current-time {
            font-weight: bold;
            color: #333;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: none;
        }
        .playback-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .playback-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .playback-btn:hover {
            background: #45a049;
        }
        .playback-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
        }
        .speed-control label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        .speed-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }
        .snapshot-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .axis-label {
            font-size: 14px;
            font-weight: bold;
            fill: #333;
        }
        .axis-line {
            stroke: #333;
            stroke-width: 2;
        }
        .tick text {
            font-size: 12px;
            fill: #666;
        }
        .bids {
            fill: rgba(0, 255, 0, 0.2);
            stroke: rgb(0, 200, 0);
            stroke-width: 2;
        }
        .asks {
            fill: rgba(255, 0, 0, 0.2);
            stroke: rgb(200, 0, 0);
            stroke-width: 2;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            white-space: pre;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>kSHIB Orderbook</h1>
            <div>
                <input type="file" id="fileInput" class="file-input" accept=".txt,.json">
            </div>
        </div>
        
        <div class="info-box">
            <h3>Expected HyperLiquid JSON Format:</h3>
            <pre class="code-sample">
{
  "time": "2025-09-01T23:00:01.824781641",  // ISO timestamp
  "raw": {
    "channel": "l2Book",
    "data": {
      "coin": "kSHIB",
      "time": 1756767599936,  // Unix timestamp (ms)
      "levels": [
        [ // Bids (Buy Orders)
          {"px": "0.011957", "sz": "110036.0", "n": 2},  // Price, Size, Number of Orders
          ...
        ],
        [ // Asks (Sell Orders)
          {"px": "0.011961", "sz": "117488.0", "n": 2},
          ...
        ]
      ]
    }
  }
}</pre>
        </div>
        
        <div class="timeline-controls" id="timelineControls" style="display: none;">
            <h3>Timeline Navigation</h3>
            <div class="time-display">
                <div>
                    <strong>Current Time:</strong> <span id="currentTime" class="current-time">-</span>
                </div>
                <div class="snapshot-info">
                    Snapshot <span id="snapshotIndex">0</span> of <span id="totalSnapshots">0</span>
                </div>
            </div>
            <div class="slider-container">
                <input type="range" id="timelineSlider" class="slider" min="0" max="0" value="0">
            </div>
            <div class="playback-controls">
                <button id="playBtn" class="playback-btn">▶ Play</button>
                <button id="prevBtn" class="playback-btn">◀ Previous</button>
                <button id="nextBtn" class="playback-btn">Next ▶</button>
                <div class="speed-control">
                    <label for="speedSelect">Speed:</label>
                    <select id="speedSelect" class="speed-select">
                        <option value="10">Ultra Fast (10ms)</option>
                        <option value="25">Very Fast (25ms)</option>
                        <option value="50" selected>Fast (50ms)</option>
                        <option value="100">Normal (100ms)</option>
                        <option value="250">Slow (250ms)</option>
                        <option value="500">Very Slow (500ms)</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="metrics">
            <div class="metric">
                <h3>Best Bid</h3>
                <div id="bestBid" class="value">-</div>
            </div>
            <div class="metric">
                <h3>Best Ask</h3>
                <div id="bestAsk" class="value">-</div>
            </div>
            <div class="metric">
                <h3>Spread</h3>
                <div id="spread" class="value">-</div>
            </div>
            <div class="metric">
                <h3>Total Bid Volume</h3>
                <div id="bidVolume" class="value">-</div>
            </div>
            <div class="metric">
                <h3>Total Ask Volume</h3>
                <div id="askVolume" class="value">-</div>
            </div>
        </div>

        <div id="chart" class="chart-container"></div>
    </div>

    <script>
        // Initialize the visualization
        const margin = {top: 40, right: 60, bottom: 50, left: 120};
        const width = 1000 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Global state for timeline
        let allSnapshots = [];
        let currentSnapshotIndex = 0;
        let playbackInterval = null;
        let isPlaying = false;
        let playbackSpeed = 50; // Default to 50ms (fast, real-time feel)

        function processOrderbook(data) {
            const snapshot = JSON.parse(data);
            const levels = snapshot.raw.data.levels;
            
            // Extract time information
            const isoTime = snapshot.time || null;
            const unixTime = snapshot.raw.data.time || null;
            
            // Process bids and asks
            let bids = [];
            let asks = [];
            let cumBidSize = 0;
            let cumAskSize = 0;
            
            // Process bids (buy orders)
            levels[0].forEach(bid => {
                cumBidSize += parseFloat(bid.sz);
                bids.push({
                    price: parseFloat(bid.px),
                    size: parseFloat(bid.sz),
                    cumSize: cumBidSize,
                    orders: parseInt(bid.n)
                });
            });
            
            // Process asks (sell orders)
            levels[1].forEach(ask => {
                cumAskSize += parseFloat(ask.sz);
                asks.push({
                    price: parseFloat(ask.px),
                    size: parseFloat(ask.sz),
                    cumSize: cumAskSize,
                    orders: parseInt(ask.n)
                });
            });

            return { bids, asks, isoTime, unixTime };
        }
        
        function formatTime(isoTime, unixTime) {
            if (isoTime) {
                // Format ISO time for display
                const date = new Date(isoTime);
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    fractionalSecondDigits: 3
                });
            } else if (unixTime) {
                // Format Unix timestamp
                const date = new Date(unixTime);
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    fractionalSecondDigits: 3
                });
            }
            return 'No timestamp';
        }

        function updateMetrics(bids, asks) {
            if (bids.length === 0 || asks.length === 0) return;

            const bestBid = bids[0].price;
            const bestAsk = asks[0].price;
            const spread = bestAsk - bestBid;
            const totalBidVolume = bids[bids.length - 1].cumSize;
            const totalAskVolume = asks[asks.length - 1].cumSize;

            document.getElementById('bestBid').textContent = bestBid.toFixed(6);
            document.getElementById('bestAsk').textContent = bestAsk.toFixed(6);
            document.getElementById('spread').textContent = spread.toFixed(6);
            document.getElementById('bidVolume').textContent = totalBidVolume.toLocaleString();
            document.getElementById('askVolume').textContent = totalAskVolume.toLocaleString();
        }

        function updateVisualization(bids, asks) {
            // Clear previous elements
            svg.selectAll("*").remove();

            // Set up scales
            const xScale = d3.scaleLinear()
                .domain([
                    d3.min(bids, d => d.price) * 0.9999,
                    d3.max(asks, d => d.price) * 1.0001
                ])
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max([
                    d3.max(bids, d => d.cumSize),
                    d3.max(asks, d => d.cumSize)
                ])])
                .range([height, 0]);

            // Create step area generators for a more accurate orderbook representation
            const bidArea = d3.area()
                .x(d => xScale(d.price))
                .y0(height)
                .y1(d => yScale(d.cumSize))
                .curve(d3.curveStepAfter);  // Use steps instead of curves

            const askArea = d3.area()
                .x(d => xScale(d.price))
                .y0(height)
                .y1(d => yScale(d.cumSize))
                .curve(d3.curveStepAfter);  // Use steps instead of curves

            // Add the areas
            svg.append("path")
                .datum(bids)
                .attr("class", "bids")
                .attr("d", bidArea);

            svg.append("path")
                .datum(asks)
                .attr("class", "asks")
                .attr("d", askArea);

            // Add axes with labels
            const xAxis = d3.axisBottom(xScale).tickFormat(d3.format(".6f"));
            const yAxis = d3.axisLeft(yScale)
                .tickFormat(d => d3.format(",.0f")(d))
                .ticks(10)  // Limit number of ticks
                .tickPadding(12);  // Slight padding for number readability

            // X-axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);

            // X-axis with styling
            const xAxisG = svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);
            
            xAxisG.selectAll("path")
                .attr("class", "axis-line");
            
            // X-axis label
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .text("Price (USDC)");

            // Y-axis with styling
            const yAxisG = svg.append("g")
                .call(yAxis);
            
            yAxisG.selectAll("path")
                .attr("class", "axis-line");
            
            // Y-axis label - positioned far to the left of the axis
            svg.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 30)  // Position label just to the left of the numbers
                .text("Cumulative Size");

            // Add interactive points
            function showTooltip(event, d, type) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(
                    `${type}\nPrice: ${d.price.toFixed(6)}\nSize: ${d.size.toFixed(1)}\nCumulative: ${d.cumSize.toFixed(1)}\nOrders: ${d.orders}`
                )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }

            function hideTooltip() {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            }

            // Add bid points
            svg.selectAll(".bid-point")
                .data(bids)
                .enter()
                .append("circle")
                .attr("class", "bid-point")
                .attr("cx", d => xScale(d.price))
                .attr("cy", d => yScale(d.cumSize))
                .attr("r", 3)
                .attr("fill", "green")
                .on("mouseover", (e, d) => showTooltip(e, d, "Bid"))
                .on("mouseout", hideTooltip);

            // Add ask points
            svg.selectAll(".ask-point")
                .data(asks)
                .enter()
                .append("circle")
                .attr("class", "ask-point")
                .attr("cx", d => xScale(d.price))
                .attr("cy", d => yScale(d.cumSize))
                .attr("r", 3)
                .attr("fill", "red")
                .on("mouseover", (e, d) => showTooltip(e, d, "Ask"))
                .on("mouseout", hideTooltip);
        }

        // Timeline control functions
        function loadSnapshot(index) {
            if (index < 0 || index >= allSnapshots.length) return;
            
            currentSnapshotIndex = index;
            const snapshot = allSnapshots[index];
            const { bids, asks, isoTime, unixTime } = processOrderbook(snapshot);
            
            updateMetrics(bids, asks);
            updateVisualization(bids, asks);
            
            // Update time display
            document.getElementById('currentTime').textContent = formatTime(isoTime, unixTime);
            document.getElementById('snapshotIndex').textContent = index + 1;
            document.getElementById('timelineSlider').value = index;
        }
        
        function playSnapshots() {
            if (isPlaying) {
                // Stop playback
                clearInterval(playbackInterval);
                isPlaying = false;
                document.getElementById('playBtn').textContent = '▶ Play';
                document.getElementById('playBtn').disabled = false;
            } else {
                // Start playback
                isPlaying = true;
                document.getElementById('playBtn').textContent = '⏸ Pause';
                
                playbackInterval = setInterval(() => {
                    if (currentSnapshotIndex >= allSnapshots.length - 1) {
                        // End of timeline, stop playback
                        clearInterval(playbackInterval);
                        isPlaying = false;
                        document.getElementById('playBtn').textContent = '▶ Play';
                        return;
                    }
                    loadSnapshot(currentSnapshotIndex + 1);
                }, playbackSpeed); // Use current playback speed
            }
        }
        
        function updatePlaybackSpeed() {
            playbackSpeed = parseInt(document.getElementById('speedSelect').value);
            
            // If currently playing, restart with new speed
            if (isPlaying) {
                clearInterval(playbackInterval);
                playbackInterval = setInterval(() => {
                    if (currentSnapshotIndex >= allSnapshots.length - 1) {
                        clearInterval(playbackInterval);
                        isPlaying = false;
                        document.getElementById('playBtn').textContent = '▶ Play';
                        return;
                    }
                    loadSnapshot(currentSnapshotIndex + 1);
                }, playbackSpeed);
            }
        }
        
        function previousSnapshot() {
            if (currentSnapshotIndex > 0) {
                loadSnapshot(currentSnapshotIndex - 1);
            }
        }
        
        function nextSnapshot() {
            if (currentSnapshotIndex < allSnapshots.length - 1) {
                loadSnapshot(currentSnapshotIndex + 1);
            }
        }
        
        // Setup timeline controls
        document.getElementById('playBtn').addEventListener('click', playSnapshots);
        document.getElementById('prevBtn').addEventListener('click', previousSnapshot);
        document.getElementById('nextBtn').addEventListener('click', nextSnapshot);
        document.getElementById('speedSelect').addEventListener('change', updatePlaybackSpeed);
        document.getElementById('timelineSlider').addEventListener('input', function(e) {
            loadSnapshot(parseInt(e.target.value));
        });

        // File input handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n').filter(line => line.trim());
                if (lines.length === 0) return;

                // Store all snapshots
                allSnapshots = lines;
                currentSnapshotIndex = 0;
                
                // Show timeline controls if there are multiple snapshots
                if (allSnapshots.length > 1) {
                    document.getElementById('timelineControls').style.display = 'block';
                    document.getElementById('timelineSlider').max = allSnapshots.length - 1;
                    document.getElementById('totalSnapshots').textContent = allSnapshots.length;
                } else {
                    document.getElementById('timelineControls').style.display = 'none';
                }
                
                // Load the first snapshot
                loadSnapshot(0);
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>
